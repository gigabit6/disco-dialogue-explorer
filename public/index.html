<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Dialogue Explorer (Node UI)</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<header>
    Disco Explorer (Node UI)
</header>
<main>
    <div class="tabs">
        <div class="tab active" data-tab="search">Search</div>
        <div class="tab" data-tab="browse">Browse</div>
        <div class="tab" data-tab="dump">Dump</div>
        <div class="tab" data-tab="variables">Variables</div>
    </div>

    <!-- Search tab -->
    <section id="tab-search" class="tab-content active">
        <div class="panel">
            <div class="row">
                <label>Search text:
                    <input id="searchText" type="text" size="40" />
                </label>
                <select id="searchActorName"></select>
                <label>Style:
                    <select id="searchStyle">
                        <option value="all">all words</option>
                        <option value="any">any word</option>
                        <option value="phrase">exact phrase</option>
                        <option value="variable">variable / condition</option>
                    </select>
                </label>
                <button id="btnSearch">Search</button>
            </div>
            <div class="row">
                <span class="label">Selected line:</span>
                <span id="selectedLineText">(none)</span>
            </div>
            <div class="row">
                <span class="label">Results:</span>
                <span id="resultsCount"></span>
            </div>
            <div style="display:flex; gap:8px; height: 260px;">
                <div style="flex:1; overflow:auto; border:1px solid #ddd;">
                    <ul id="resultsList"></ul>
                </div>
                <div style="flex:1; border:1px solid #ddd;">
                    <textarea id="currentLinePreview" readonly></textarea>
                    <button id="btnGoToBrowse" disabled>Open in Browse tab</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Browse tab -->
    <section id="tab-browse" class="tab-content">
        <div class="panel">
            <div class="row">
                <span class="label">Conversation info:</span>
                <span id="browseConversationInfo"></span>
            </div>
        </div>
        <div class="panel">
            <div class="label">Conversation:</div>
            <textarea id="browseConvo" readonly></textarea>
        </div>
        <div class="panel">
            <div class="row">
                <div style="flex:1;">
                    <div class="label">Backwards options (parents):</div>
                    <ul id="backOptions"></ul>
                </div>
                <div style="flex:1;">
                    <div class="label">Forward options (children):</div>
                    <ul id="forwardOptions"></ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Dump tab -->
    <section id="tab-dump" class="tab-content">
        <div class="panel">
            <div class="row">
                <button id="btnDumpConvo">Dump current conversation</button>
                <label>Dump by actor name:
                    <select id="dumpActorName"></select>
                </label>
                <button id="btnDumpActor">Dump actor</button>
            </div>
            <div class="row">
                <span class="label">Conversation info:</span>
                <span id="dumpConversationInfo"></span>
            </div>
        </div>
        <div class="panel">
            <textarea id="dumpText" readonly></textarea>
        </div>
    </section>

    <!-- Variables tab -->
    <section id="tab-variables" class="tab-content">
        <h2>Variables</h2>

        <div class="var-search-row">
            <input
                    type="text"
                    id="varSearchInput"
                    class="text-input"
                    placeholder="Search variables by name or description... (min 2 chars)"
            />
            <button id="varSearchButton" class="btn">Search</button>
            <button id="varSearchClear" class="btn secondary">Clear</button>
        </div>

        <div id="varSearchInfo" class="info-text">
            Type at least 2 characters to search, or leave empty and click Search to list the first 100 variables.
        </div>

        <table id="varResultsTable" class="styled-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
            </tr>
            </thead>
            <tbody id="varResultsBody">
            <!-- results injected here -->
            </tbody>
        </table>
    </section>
</main>

<script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
    });

    async function postJSON(url, body) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body || {})
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
    }

    // --- Search ---
    const searchText = document.getElementById('searchText');
    const searchActorName = document.getElementById('searchActorName');
    const searchStyle = document.getElementById('searchStyle');
    const btnSearch = document.getElementById('btnSearch');
    const resultsList = document.getElementById('resultsList');
    const resultsCount = document.getElementById('resultsCount');
    const selectedLineText = document.getElementById('selectedLineText');
    const currentLinePreview = document.getElementById('currentLinePreview');
    const btnGoToBrowse = document.getElementById('btnGoToBrowse');

    let lastSearchResults = [];

    btnSearch.addEventListener('click', async () => {
        resultsList.innerHTML = '';
        resultsCount.textContent = 'Searching...';
        selectedLineText.textContent = '(none)';
        currentLinePreview.value = '';
        btnGoToBrowse.disabled = true;

        try {
            const data = await postJSON('/api/search', {
                query: searchText.value,
                actorId: searchActorName.value,
                style: searchStyle.value
            });
            lastSearchResults = data.results || [];
            resultsCount.textContent = `${lastSearchResults.length} result(s)`;
            lastSearchResults.forEach((text, idx) => {
                const li = document.createElement('li');
                li.textContent = `${idx}: ${text}`;
                li.dataset.index = idx;
                resultsList.appendChild(li);
            });
        } catch (e) {
            resultsCount.textContent = 'Error: ' + e.message;
        }
    });

    resultsList.addEventListener('click', async (ev) => {
        const li = ev.target.closest('li');
        if (!li) return;
        const index = parseInt(li.dataset.index, 10);
        try {
            const data = await postJSON('/api/select-search', { index });
            selectedLineText.textContent = data.selectedLine || '(none)';
            currentLinePreview.value = data.convoText || '';
            btnGoToBrowse.disabled = false;
            // Also prime browse tab content
            updateBrowseUI(data);
        } catch (e) {
            selectedLineText.textContent = 'Error: ' + e.message;
        }
    });

    btnGoToBrowse.addEventListener('click', () => {
        document.querySelector('.tab[data-tab="browse"]').click();
    });

    // --- Browse ---
    const browseConvo = document.getElementById('browseConvo');
    const browseConversationInfo = document.getElementById('browseConversationInfo');
    const backOptions = document.getElementById('backOptions');
    const forwardOptions = document.getElementById('forwardOptions');

    function updateBrowseUI(data) {
        browseConvo.value = data.convoText || '';
        browseConversationInfo.textContent = data.conversationInfo || '';
        backOptions.innerHTML = '';
        forwardOptions.innerHTML = '';

        (data.backwardOptions || []).forEach((opt, idx) => {
            const li = document.createElement('li');
            li.textContent = opt;
            li.dataset.index = idx;
            li.addEventListener('click', () => trace('backward', idx));
            backOptions.appendChild(li);
        });

        (data.forwardOptions || []).forEach((opt, idx) => {
            const li = document.createElement('li');
            li.textContent = opt;
            li.dataset.index = idx;
            li.addEventListener('click', () => trace('forward', idx));
            forwardOptions.appendChild(li);
        });
    }

    async function trace(direction, index) {
        try {
            const data = await postJSON('/api/trace', { direction, index });
            updateBrowseUI(data);
        } catch (e) {
            alert('Trace error: ' + e.message);
        }
    }

    // --- Dump ---
    const btnDumpConvo = document.getElementById('btnDumpConvo');
    const btnDumpActor = document.getElementById('btnDumpActor');
    const dumpActorName = document.getElementById('dumpActorName');
    const dumpText = document.getElementById('dumpText');
    const dumpConversationInfo = document.getElementById('dumpConversationInfo');

    btnDumpConvo.addEventListener('click', async () => {
        try {
            const data = await postJSON('/api/dump-convo');
            dumpText.value = data.text || '';
            dumpConversationInfo.textContent = data.conversationInfo || '';
        } catch (e) {
            dumpText.value = 'Error: ' + e.message;
        }
    });

    btnDumpActor.addEventListener('click', async () => {
        try {
            const data = await postJSON('/api/dump-actor', {
                actorId: dumpActorName.value
            });
            dumpText.value = data.text || '';
            dumpConversationInfo.textContent = '';
        } catch (e) {
            dumpText.value = 'Error: ' + e.message;
        }
    });
</script>

<script>
    fetch('/api/actors')
        .then(res => {
            if (!res.ok) {
                throw new Error('Failed to load actors');
            }
            return res.json();
        })
        .then(actors => {
            const select = document.getElementById('searchActorName');
            const dump = document.getElementById('dumpActorName');

            actors.forEach(actor => {
                const opt = document.createElement('option');
                opt.value = actor.id; // same as before
                opt.textContent = `${actor.name} (${actor.line_count} lines)`;
                select.appendChild(opt);
                dump.appendChild(opt.cloneNode(true));
            });
        })
        .catch(err => {
            console.error(err);
        });
</script>

<script>
    // --- Variables tab search ---
    const varSearchInput = document.getElementById('varSearchInput');
    const varSearchButton = document.getElementById('varSearchButton');
    const varSearchClear = document.getElementById('varSearchClear');
    const varResultsBody = document.getElementById('varResultsBody');
    const varSearchInfo = document.getElementById('varSearchInfo');

    async function fetchVariables(query) {
        const params = query ? ('?q=' + encodeURIComponent(query)) : '';
        const res = await fetch('/api/variables' + params);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
    }

    function renderVariables(vars) {
        varResultsBody.innerHTML = '';
        if (!vars || vars.length === 0) {
            varResultsBody.innerHTML = `
        <tr><td colspan="3"><em>No variables found.</em></td></tr>
      `;
            return;
        }

        for (const v of vars) {
            const tr = document.createElement('tr');

            tr.innerHTML = `
        <td>${v.id}</td>
        <td>${v.name || ''}</td>
        <td>${v.description || ''}</td>
      `;

            varResultsBody.appendChild(tr);
        }
    }

    async function doVariableSearch() {
        const q = varSearchInput.value.trim();

        if (q && q.length > 0 && q.length < 2) {
            varSearchInfo.textContent = 'Please type at least 2 characters.';
            return;
        }

        varSearchInfo.textContent = 'Searching...';

        try {
            const vars = await fetchVariables(q);
            renderVariables(vars);
            varSearchInfo.textContent = `Found ${vars.length} variable(s).`;
        } catch (err) {
            console.error('Variable search error', err);
            varSearchInfo.textContent = 'Error searching variables.';
        }
    }

    varSearchButton.addEventListener('click', doVariableSearch);
    varSearchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') doVariableSearch();
    });
    varSearchClear.addEventListener('click', () => {
        varSearchInput.value = '';
        varSearchInfo.textContent =
            'Type at least 2 characters to search, or leave empty and click Search.';
        varResultsBody.innerHTML = '';
    });
</script>
</body>
</html>
